<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Unified Production Scanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Core Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* FIX: Use 100dvh for mobile browsers to account for address bars */
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f8fafc; 
            height: 100dvh; 
            width: 100vw;
            overflow: hidden;
            position: fixed; /* Prevents rubber-banding on iOS */
        }
        #root { height: 100%; width: 100%; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .mode-card { transition: all 0.2s; border: 2px solid transparent; }
        .mode-card:active { transform: scale(0.98); }
        
        /* Safe area padding for iPhones with notches */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icons = {
            Bolt: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>,
            Shield: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
            Brain: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/><path d="M3 9l3 3-3 3"/><path d="M21 9l-3 3 3 3"/><path d="M12 3v3"/><path d="M12 18v3"/></svg>,
            Camera: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
            FileText: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            Check: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Trash: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Settings: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        };

        // --- UTILS ---
        const compressImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_SIZE = 800;
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; } } 
                    else { if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
            };
        });

        const generatePDF = (history, batchId) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20); doc.setTextColor(40, 40, 40);
            doc.text("Production Manifest", 14, 20);
            doc.setFontSize(10); doc.text(`Batch: ${batchId || 'N/A'}`, 14, 30); doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 35);
            const tableRows = history.map(h => [h.timestamp.split(',')[1], h.data, h.status, h.sync]);
            doc.autoTable({ startY: 50, head: [["Time", "Data", "Status", "Sync"]], body: tableRows, theme: 'grid' });
            doc.save(`Manifest_${batchId}_${Date.now()}.pdf`);
        };

        // --- MAIN APP ---
        function App() {
            const [mode, setMode] = useState(localStorage.getItem('app_mode') || 'select'); 
            const [view, setView] = useState('scan');
            const [batchId, setBatchId] = useState(localStorage.getItem('batch') || '');
            const [status, setStatus] = useState('Pass'); 
            const [scannedData, setScannedData] = useState(null);
            const [photoData, setPhotoData] = useState(null);
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [loading, setLoading] = useState(false);
            const [history, setHistory] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('history') || '[]');
                } catch (e) { return []; }
            });
            const [scriptUrl, setScriptUrl] = useState(localStorage.getItem('scriptUrl') || '');
            const [notification, setNotification] = useState(null);
            
            const scannerRef = useRef(null);
            const fileRef = useRef(null);

            useEffect(() => { localStorage.setItem('batch', batchId); }, [batchId]);
            
            // SAFE LOCAL STORAGE SAVING
            useEffect(() => { 
                try {
                    localStorage.setItem('history', JSON.stringify(history)); 
                } catch (e) {
                    console.error("Storage full", e);
                    // If full, try to remove oldest item or just don't save
                }
            }, [history]);
            
            useEffect(() => { localStorage.setItem('scriptUrl', scriptUrl); }, [scriptUrl]);
            useEffect(() => { if(mode !== 'select') localStorage.setItem('app_mode', mode); }, [mode]);

            const showNotify = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const startScan = () => {
                setScannedData(null); setPhotoData(null); setStatus('Pass'); setAiAnalysis(null);
                if (!window.Html5Qrcode) return showNotify('Scanner loading...', 'error');
                setTimeout(() => {
                    const html5QrCode = new window.Html5Qrcode("reader");
                    scannerRef.current = html5QrCode;
                    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, 
                        (decoded) => {
                            setScannedData(decoded);
                            html5QrCode.stop().then(() => html5QrCode.clear());
                            if (mode === 'advanced') {
                                setTimeout(() => {
                                    const isDefect = Math.random() > 0.8; 
                                    setAiAnalysis({
                                        verdict: isDefect ? 'Defect Detected' : 'Visual Pass',
                                        confidence: '98.5%',
                                        suggestion: isDefect ? 'Route to Reject' : 'Route to Stock'
                                    });
                                    if(isDefect) setStatus('Reject');
                                }, 800);
                            }
                        }, () => {}
                    ).catch(() => showNotify('Camera denied', 'error'));
                }, 100);
            };

            const handlePhoto = async (e) => {
                if(e.target.files[0]) {
                    setLoading(true);
                    try {
                        const data = await compressImage(e.target.files[0]);
                        setPhotoData(data);
                    } catch(err) { showNotify('Image Error', 'error'); }
                    setLoading(false);
                }
            };

            const upload = async () => {
                if(!scriptUrl) return showNotify('Set Script URL in Setup', 'error');
                setLoading(true);
                
                const timestamp = new Date().toLocaleString();
                
                // Payload for Cloud (Includes Image)
                const cloudPayload = { 
                    data: scannedData, batch: batchId, status: mode === 'basic' ? 'Pass' : status, 
                    image: photoData, mode: mode, ai_tags: aiAnalysis ? aiAnalysis.verdict : '', timestamp: timestamp 
                };

                // Payload for Local History (EXCLUDES Image to prevent crash)
                const localPayload = { 
                    data: scannedData, batch: batchId, status: mode === 'basic' ? 'Pass' : status, 
                    image: null, // CRITICAL FIX: Do not save base64 to local storage
                    has_photo: !!photoData,
                    mode: mode, ai_tags: aiAnalysis ? aiAnalysis.verdict : '', timestamp: timestamp 
                };

                try {
                    await fetch(scriptUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(cloudPayload) });
                    const newItem = {...localPayload, id: Date.now(), sync: 'Done'};
                    setHistory(prev => [newItem, ...prev]);
                    
                    setScannedData(null); setPhotoData(null); setAiAnalysis(null);
                    showNotify('Saved Successfully');
                } catch (e) {
                    console.error(e);
                    const newItem = {...localPayload, id: Date.now(), sync: 'Offline'};
                    setHistory(prev => [newItem, ...prev]);
                    showNotify('Saved Locally (Offline)', 'warning');
                }
                setLoading(false);
            };

            // --- SCREEN: MODE SELECT ---
            if (mode === 'select') {
                return (
                    <div className="h-full bg-gradient-to-br from-slate-900 to-slate-800 text-white p-6 flex flex-col justify-center overflow-y-auto">
                        <div className="text-center mb-10">
                            <h1 className="text-3xl font-bold mb-2">Production Suite</h1>
                            <p className="text-slate-400">Select your operational mode</p>
                        </div>
                        <div className="space-y-4 max-w-md mx-auto w-full pb-10">
                            <div onClick={() => setMode('basic')} className="mode-card bg-white/5 p-4 rounded-xl flex items-center gap-4 cursor-pointer hover:bg-white/10">
                                <div className="p-3 bg-blue-500/20 rounded-lg text-blue-400"><Icons.Bolt /></div>
                                <div><h3 className="font-bold text-lg">Basic Tracker</h3><p className="text-xs text-slate-400">Scan & Log only.</p></div>
                            </div>
                            <div onClick={() => setMode('pro')} className="mode-card bg-white/5 p-4 rounded-xl flex items-center gap-4 cursor-pointer hover:bg-white/10 border border-blue-500/30 bg-blue-500/5">
                                <div className="p-3 bg-green-500/20 rounded-lg text-green-400"><Icons.Shield /></div>
                                <div><h3 className="font-bold text-lg">Pro Inspector</h3><p className="text-xs text-slate-400">Photo + QC Status.</p></div>
                            </div>
                            <div onClick={() => setMode('advanced')} className="mode-card bg-white/5 p-4 rounded-xl flex items-center gap-4 cursor-pointer hover:bg-white/10">
                                <div className="p-3 bg-purple-500/20 rounded-lg text-purple-400"><Icons.Brain /></div>
                                <div><h3 className="font-bold text-lg">Intel Auditor</h3><p className="text-xs text-slate-400">AI + Auto-Route.</p></div>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- MAIN LAYOUT ---
            return (
                <div className="flex flex-col h-full max-w-md mx-auto bg-slate-50 shadow-2xl md:border md:rounded-xl md:my-4 md:h-[95vh]">
                    {/* Header */}
                    <div className={`p-4 text-white shadow-lg flex justify-between items-center shrink-0 ${mode === 'basic' ? 'bg-blue-600' : mode === 'pro' ? 'bg-slate-800' : 'bg-gradient-to-r from-slate-900 to-purple-900'}`}>
                        <div className="font-bold flex items-center gap-2">
                            {mode === 'basic' && <Icons.Bolt className="w-5 h-5"/>}
                            {mode === 'pro' && <Icons.Shield className="w-5 h-5"/>}
                            {mode === 'advanced' && <Icons.Brain className="w-5 h-5"/>}
                            <span>{mode.toUpperCase()}</span>
                        </div>
                        <button onClick={() => setMode('select')} className="text-[10px] bg-white/20 px-2 py-1 rounded">SWITCH</button>
                    </div>

                    {notification && <div className={`absolute top-16 left-4 right-4 p-3 rounded-lg shadow-lg text-white text-center z-50 animate-fade-in ${notification.type === 'error' ? 'bg-red-500' : 'bg-emerald-600'}`}>{notification.msg}</div>}

                    {/* Scrollable Content */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {view === 'scan' && (
                            <div className="animate-fade-in space-y-4 pb-20">
                                <div className="bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                                    <label className="text-xs font-bold text-slate-400 uppercase">Batch ID</label>
                                    <input type="text" value={batchId} onChange={e => setBatchId(e.target.value)} className="w-full mt-1 p-2 bg-slate-50 border rounded-lg font-mono text-sm outline-none" placeholder="BATCH-001" />
                                </div>

                                <div className="bg-white rounded-xl shadow-sm border overflow-hidden min-h-[320px] relative flex flex-col">
                                    {!scannedData ? (
                                        <div className="flex-1 flex flex-col bg-slate-900">
                                            <div id="reader" className="flex-1 w-full relative">
                                                {!scannerRef.current && <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-500"><Icons.Camera className="w-12 h-12 mb-2 opacity-50"/><p>Ready</p></div>}
                                            </div>
                                            <button onClick={startScan} className={`py-5 font-bold text-white tracking-wide ${mode === 'basic' ? 'bg-blue-600' : mode === 'pro' ? 'bg-emerald-600' : 'bg-purple-600'}`}>TAP TO SCAN</button>
                                        </div>
                                    ) : (
                                        <div className="flex-1 flex flex-col p-4 space-y-4 bg-white">
                                            <div className="bg-emerald-50 border border-emerald-100 p-4 rounded-xl flex items-start gap-3">
                                                <div className="bg-emerald-100 p-2 rounded-full text-emerald-600"><Icons.Check className="w-5 h-5"/></div>
                                                <div className="overflow-hidden"><div className="text-xs font-bold text-emerald-600 uppercase">Data</div><div className="font-mono font-bold text-slate-800 break-all">{scannedData}</div></div>
                                            </div>
                                            {mode === 'advanced' && aiAnalysis && (
                                                <div className="bg-slate-900 text-slate-300 p-3 rounded-xl text-sm border border-slate-700">
                                                    <div className="flex justify-between items-center mb-1"><span className="flex items-center gap-2 text-purple-400 font-bold"><Icons.Brain className="w-4 h-4"/> AI Analysis</span><span className="text-xs bg-purple-900 text-purple-300 px-1.5 rounded">{aiAnalysis.confidence}</span></div>
                                                    <div className="text-white font-medium">{aiAnalysis.verdict}</div>
                                                </div>
                                            )}
                                            {mode !== 'basic' && (
                                                <>
                                                    <div>
                                                        <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Status</label>
                                                        <div className="grid grid-cols-3 gap-2">{['Pass', 'Rework', 'Reject'].map(s => <button key={s} onClick={() => setStatus(s)} className={`py-2 text-sm rounded-lg font-bold border ${status === s ? 'bg-emerald-100 border-emerald-500 text-emerald-700' : 'bg-white border-slate-200 text-slate-500'}`}>{s}</button>)}</div>
                                                    </div>
                                                    <div className="flex-1 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50 relative group overflow-hidden min-h-[120px] flex flex-col items-center justify-center">
                                                        {!photoData ? <div onClick={() => fileRef.current.click()} className="text-center cursor-pointer p-4"><Icons.Camera className="w-6 h-6 text-slate-400 mb-1 mx-auto"/><span className="text-xs font-bold text-slate-500">Add Photo</span><input type="file" ref={fileRef} className="hidden" accept="image/*" capture="environment" onChange={handlePhoto}/></div> : <><img src={photoData} className="absolute inset-0 w-full h-full object-cover"/><button onClick={() => setPhotoData(null)} className="absolute bottom-2 right-2 bg-white text-red-600 px-2 py-1 rounded text-xs font-bold shadow">Retake</button></>}
                                                    </div>
                                                </>
                                            )}
                                            <div className="grid grid-cols-2 gap-3 mt-auto">
                                                <button onClick={() => setScannedData(null)} className="py-3 rounded-xl font-bold text-slate-500 bg-slate-200">Cancel</button>
                                                <button onClick={upload} disabled={loading} className="py-3 rounded-xl font-bold text-white bg-blue-600">{loading ? 'Saving...' : 'Upload'}</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'history' && (
                            <div className="animate-fade-in space-y-4 pb-20">
                                <div className="flex justify-between items-center"><h2 className="font-bold text-slate-700">Session Log</h2><div className="flex gap-2">{mode === 'advanced' && history.length > 0 && <button onClick={() => generatePDF(history, batchId)} className="text-purple-600 bg-purple-50 px-3 py-1 rounded-lg text-xs font-bold border border-purple-100">PDF</button>}<button onClick={() => {if(confirm('Clear?')) setHistory([])}} className="text-red-500 bg-red-50 px-3 py-1 rounded-lg text-xs font-bold border border-red-100">Clear</button></div></div>
                                {history.map((item, i) => (
                                    <div key={i} className="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex justify-between items-start">
                                        <div><div className="font-bold text-sm text-slate-800">{item.data}</div><div className="text-xs text-slate-500 mt-1">{item.timestamp.split(',')[1]}</div></div>
                                        <div className="flex flex-col items-end gap-1">
                                            <div className={`text-[10px] px-2 py-0.5 rounded-full font-bold border ${item.status === 'Pass' ? 'bg-emerald-50 text-emerald-600 border-emerald-200' : 'bg-amber-50 text-amber-600 border-amber-200'}`}>{item.status}</div>
                                            {item.has_photo && <div className="text-[10px] text-slate-400 flex items-center gap-1"><Icons.Camera className="w-3 h-3"/> Photo</div>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="animate-fade-in space-y-4 pb-20">
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100"><label className="text-xs font-bold text-slate-400 uppercase block mb-2">Script URL</label><textarea value={scriptUrl} onChange={e => setScriptUrl(e.target.value)} className="w-full p-3 bg-slate-50 border rounded-lg text-xs font-mono focus:ring-2 focus:ring-blue-500 outline-none" rows="4"></textarea></div>
                            </div>
                        )}
                    </div>

                    {/* Footer Nav */}
                    <div className="bg-white border-t border-slate-100 flex justify-around py-3 text-[10px] font-bold text-slate-400 uppercase tracking-wide shrink-0 pb-safe w-full fixed bottom-0 max-w-md md:absolute">
                        <button onClick={() => setView('scan')} className={`flex flex-col items-center gap-1 ${view === 'scan' ? 'text-blue-600' : ''}`}><Icons.Camera className="w-6 h-6"/> Scan</button>
                        <button onClick={() => setView('history')} className={`flex flex-col items-center gap-1 ${view === 'history' ? 'text-blue-600' : ''}`}><Icons.FileText className="w-6 h-6"/> Log</button>
                        <button onClick={() => setView('settings')} className={`flex flex-col items-center gap-1 ${view === 'settings' ? 'text-blue-600' : ''}`}><Icons.Settings className="w-6 h-6"/> Setup</button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>