<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProdSync</title>
    
    <!-- PWA & Mobile Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    
    <!-- APP ICON (Base64 SVG) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%232563eb%22 rx=%2220%22/><path d=%22M50 20 L20 35 L50 50 L80 35 Z M20 50 L50 65 L80 50 M20 65 L50 80 L80 65%22 fill=%22none%22 stroke=%22white%22 stroke-width=%226%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22/></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%232563eb%22/><path d=%22M50 20 L20 35 L50 50 L80 35 Z M20 50 L50 65 L80 50 M20 65 L50 80 L80 65%22 fill=%22none%22 stroke=%22white%22 stroke-width=%226%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22/></svg>">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Core Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f1f5f9; 
            height: 100dvh; 
            width: 100vw;
            overflow: hidden;
            position: fixed;
        }
        #root { height: 100%; width: 100%; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-purple { 0% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(147, 51, 234, 0); } 100% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0); } }
        
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        .animate-pulse-ring { animation: pulse-purple 2s infinite; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        textarea::-webkit-scrollbar { width: 4px; }
        
        .accordion-content { transition: max-height 0.3s ease-out; overflow: hidden; max-height: 0; }
        .accordion-content.open { max-height: 500px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const ADMIN_PIN = "8888"; 
        const APP_VERSION = "v4.2";

        const NOTES_REJECT = [
            "Damaged Box", "Label Missing", "Scratches/Dents", 
            "Wrong Color", "Missing Parts", "Function Fail", 
            "Rust/Corrosion", "Software Error"
        ];

        const NOTES_PASS = [
            "Visual Check OK", "Label Verified", "Packaging OK", 
            "Accessories Present", "Cleaned", "Weight Checked"
        ];

        const Icons = {
            Logo: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/><path d="M12 22V12" strokeOpacity="0.5"/></svg>,
            Bolt: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>,
            Shield: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
            Brain: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/><path d="M3 9l3 3-3 3"/><path d="M21 9l-3 3 3 3"/><path d="M12 3v3"/><path d="M12 18v3"/></svg>,
            Camera: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
            FileText: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            Check: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Alert: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Settings: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Lock: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>,
            X: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Trash: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Repeat: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>,
            CloudUpload: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>,
            Keyboard: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="4" width="20" height="16" rx="2" ry="2"></rect><line x1="6" y1="8" x2="6" y2="8"></line><line x1="10" y1="8" x2="10" y2="8"></line><line x1="14" y1="8" x2="14" y2="8"></line><line x1="18" y1="8" x2="18" y2="8"></line><line x1="6" y1="12" x2="6" y2="12"></line><line x1="10" y1="12" x2="10" y2="12"></line><line x1="14" y1="12" x2="14" y2="12"></line><line x1="18" y1="12" x2="18" y2="12"></line><line x1="6" y1="16" x2="6" y2="16"></line><line x1="10" y1="16" x2="10" y2="16"></line><line x1="14" y1="16" x2="14" y2="16"></line></svg>,
            StopCircle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><rect x="9" y="9" width="6" height="6"></rect></svg>,
            Info: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>,
            ChevronDown: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>,
            Sparkles: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
            Help: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        };

        // --- GEMINI API ---
        const callGeminiVision = async (apiKey, base64Image) => {
            if (!apiKey) throw new Error("API Key missing");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: "Analyze this manufacturing item. Check for defects. Return JSON: { \"verdict\": \"Visual Pass\" or \"Defect Detected\", \"confidence\": \"Percentage\", \"suggestion\": \"Action\" }" }, { inlineData: { mimeType: "image/jpeg", data: base64Image.split(',')[1] } }] }], generationConfig: { responseMimeType: "application/json" } };
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`Gemini API Error: ${response.status}`);
            return JSON.parse((await response.json()).candidates[0].content.parts[0].text);
        };
        
        const callGeminiSummary = async (apiKey, logData) => {
            if (!apiKey) throw new Error("API Key missing");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: `Analyze this production log and provide a 2-sentence summary of defects and throughput:\n${JSON.stringify(logData)}` }] }] };
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            return (await response.json()).candidates[0].content.parts[0].text;
        };

        const Modal = ({ isOpen, type, title, message, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 animate-fade-in">
                    <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-xs p-6 relative z-20 text-center transform transition-all border-2 border-white/20">
                        <div className={`mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4 ${type === 'success' ? 'bg-emerald-100 text-emerald-600' : type === 'ai' ? 'bg-purple-100 text-purple-600' : 'bg-rose-100 text-rose-600'}`}>
                            {type === 'success' ? <Icons.Check className="w-8 h-8" /> : type === 'ai' ? <Icons.Sparkles className="w-8 h-8" /> : <Icons.Alert className="w-8 h-8" />}
                        </div>
                        <h3 className="text-xl font-bold text-slate-800 mb-2">{String(title)}</h3>
                        <p className="text-slate-500 text-sm mb-6 leading-relaxed whitespace-pre-wrap">{String(message)}</p>
                        <button onClick={onClose} className={`w-full py-3.5 rounded-xl font-bold text-white shadow-lg transition-transform active:scale-95 ${type === 'success' ? 'bg-emerald-600 hover:bg-emerald-700' : type === 'ai' ? 'bg-purple-600 hover:bg-purple-700' : 'bg-rose-600 hover:bg-rose-700'}`}>Continue</button>
                    </div>
                </div>
            );
        };

        const AdminGate = ({ isOpen, onClose, onSuccess }) => {
            const [pin, setPin] = useState('');
            const [error, setError] = useState(false);
            useEffect(() => { if(isOpen) { setPin(''); setError(false); } }, [isOpen]);
            const handleNum = (num) => {
                if (pin.length < 4) {
                    const newPin = pin + num;
                    setPin(newPin);
                    if (newPin.length === 4) {
                        if (newPin === ADMIN_PIN) { setTimeout(onSuccess, 200); } 
                        else { setError(true); setTimeout(() => { setPin(''); setError(false); }, 500); }
                    }
                }
            };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[300] bg-slate-900/95 backdrop-blur-md flex flex-col items-center justify-center p-6 animate-fade-in">
                    <div className={`w-full max-w-xs bg-slate-800 p-6 rounded-2xl shadow-2xl border border-slate-700`}>
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-white font-bold text-lg flex items-center gap-2"><Icons.Lock className="w-5 h-5 text-blue-400"/> Admin Access</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><Icons.X className="w-6 h-6"/></button>
                        </div>
                        <div className="flex justify-center gap-3 mb-8">
                            {[0,1,2,3].map(i => (<div key={i} className={`w-4 h-4 rounded-full transition-all ${i < pin.length ? (error ? 'bg-rose-500' : 'bg-blue-500') : 'bg-slate-600'}`}></div>))}
                        </div>
                        <div className="grid grid-cols-3 gap-4">
                            {[1,2,3,4,5,6,7,8,9].map(n => (<button key={n} onClick={() => handleNum(n)} className="bg-slate-700 hover:bg-slate-600 text-white font-bold text-xl py-4 rounded-xl transition-colors shadow-lg active:scale-95">{n}</button>))}
                            <div className="col-start-2"><button onClick={() => handleNum(0)} className="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold text-xl py-4 rounded-xl transition-colors shadow-lg active:scale-95">0</button></div>
                        </div>
                    </div>
                </div>
            );
        };

        const HelpItem = ({ title, children }) => {
            const [isOpen, setIsOpen] = useState(false);
            return (
                <div className="border border-slate-200 rounded-xl overflow-hidden bg-slate-50">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex justify-between items-center p-4 text-left font-bold text-slate-700 hover:bg-slate-100"><span>{title}</span><Icons.ChevronDown className={`w-4 h-4 transition-transform ${isOpen ? 'rotate-180' : ''}`} /></button>
                    <div className={`accordion-content bg-white px-4 ${isOpen ? 'open pb-4' : ''}`}><div className="pt-2 text-sm text-slate-600 leading-relaxed">{children}</div></div>
                </div>
            );
        };

        const compressImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_SIZE = 600; 
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; } } 
                    else { if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.5));
                };
            };
        });

        const generatePDF = (history, batchId) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20); doc.text("ProdSync Report", 14, 20);
            doc.setFontSize(10); doc.text(`Batch: ${batchId || 'N/A'} | Generated: ${new Date().toLocaleString()}`, 14, 30);
            const tableRows = history.map(h => [h.timestamp.split(',')[1], h.type, h.data, h.status]);
            doc.autoTable({ startY: 40, head: [["Time", "Type", "Data", "Status"]], body: tableRows });
            doc.save(`ProdSync_Report.pdf`);
        };

        function App() {
            const [mode, setMode] = useState(localStorage.getItem('app_mode') || 'select'); 
            const [processType, setProcessType] = useState('outward'); 
            const [view, setView] = useState('scan');
            const [batchId, setBatchId] = useState(localStorage.getItem('batch') || '');
            const [operator, setOperator] = useState(localStorage.getItem('operator') || '');
            const [incharge, setIncharge] = useState(localStorage.getItem('incharge') || '');
            const [status, setStatus] = useState('Pass'); 
            const [comment, setComment] = useState('');
            const [selectedTags, setSelectedTags] = useState([]);
            const [scannedData, setScannedData] = useState(null);
            const [photoData, setPhotoData] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [loading, setLoading] = useState(false);
            const [history, setHistory] = useState(() => { try { const h = JSON.parse(localStorage.getItem('history') || '[]'); return Array.isArray(h) ? h.filter(i => i && i.data) : []; } catch (e) { return []; } });
            const [scriptUrl, setScriptUrl] = useState(localStorage.getItem('scriptUrl') || '');
            const [geminiKey, setGeminiKey] = useState(localStorage.getItem('gemini_key') || '');
            const [modal, setModal] = useState(null);
            const [showAdmin, setShowAdmin] = useState(false);
            const [pendingAction, setPendingAction] = useState(null);
            const [manualMode, setManualMode] = useState(false);
            const [manualInput, setManualInput] = useState('');
            const [cameraLoading, setCameraLoading] = useState(false);
            const [isCameraRunning, setIsCameraRunning] = useState(false);

            const scannerRef = useRef(null);
            const fileRef = useRef(null);

            useEffect(() => { localStorage.setItem('batch', batchId); }, [batchId]);
            useEffect(() => { localStorage.setItem('operator', operator); }, [operator]);
            useEffect(() => { localStorage.setItem('incharge', incharge); }, [incharge]);
            useEffect(() => { try { localStorage.setItem('history', JSON.stringify(history)); } catch (e) { console.warn("Local storage full"); } }, [history]);
            useEffect(() => { localStorage.setItem('scriptUrl', scriptUrl); }, [scriptUrl]);
            useEffect(() => { localStorage.setItem('gemini_key', geminiKey); }, [geminiKey]);
            useEffect(() => { if(mode !== 'select') localStorage.setItem('app_mode', mode); }, [mode]);
            
             useEffect(() => {
                return () => {
                    if (scannerRef.current) {
                        try { scannerRef.current.stop().then(() => scannerRef.current.clear()); } catch (e) {}
                    }
                };
            }, []);

            const requestAdmin = (actionType) => { setPendingAction(actionType); setShowAdmin(true); };
            const onAdminSuccess = () => {
                setShowAdmin(false);
                if (pendingAction === 'SWITCH_MODE') setMode('select');
                if (pendingAction === 'SETUP') setView('settings');
                if (pendingAction === 'CLEAR_HISTORY') { if(confirm('Confirm: Clear ALL history?')) setHistory([]); }
                setPendingAction(null);
            };
            
            const generateAiSummary = async () => {
                 if (!geminiKey) return setModal({ type: 'error', title: 'AI Error', message: 'Please add Gemini API Key in Setup.' });
                 if (history.length === 0) return setModal({ type: 'error', title: 'Empty Log', message: 'No data to summarize.' });
                 setLoading(true);
                 try {
                     const summary = await callGeminiSummary(geminiKey, history.slice(0, 20));
                     setModal({ type: 'ai', title: 'Shift Summary', message: summary });
                 } catch (e) { setModal({ type: 'error', title: 'AI Error', message: 'Could not generate summary. Check API Key.' }); }
                 setLoading(false);
            };

            useEffect(() => { if (processType === 'inward') setStatus('Field Return'); else setStatus('Pass'); }, [processType]);
            const toggleTag = (tag) => { if (selectedTags.includes(tag)) setSelectedTags(selectedTags.filter(t => t !== tag)); else setSelectedTags([...selectedTags, tag]); };

            const stopCamera = async () => {
                try { if (scannerRef.current) { await scannerRef.current.stop(); scannerRef.current.clear(); } } catch (err) { console.error("Stop failed", err); }
                scannerRef.current = null;
                setCameraLoading(false);
                setIsCameraRunning(false);
            };

            const startScan = () => {
                if (!batchId && processType === 'outward') return setModal({ type: 'error', title: 'Batch ID Missing', message: 'Please enter a Batch ID.' });
                setScannedData(null); setPhotoData(null); setStatus(processType === 'inward' ? 'Field Return' : 'Pass'); setAiAnalysis(null); setIsAnalyzing(false); setComment(''); setSelectedTags([]);
                if (isCameraRunning) { stopCamera(); return; }
                if (!window.Html5Qrcode) return setModal({ type: 'error', title: 'System Error', message: 'Scanner module loading...' });
                setCameraLoading(true);
                setTimeout(() => {
                    if(!document.getElementById("reader")) { setCameraLoading(false); return; }
                    if(scannerRef.current) { try{scannerRef.current.clear();}catch(e){} scannerRef.current = null; }
                    const html5QrCode = new window.Html5Qrcode("reader");
                    scannerRef.current = html5QrCode;
                    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                    const constraints = { facingMode: "environment" }; 
                    html5QrCode.start(constraints, config, 
                        async (decoded) => { try { await html5QrCode.stop(); html5QrCode.clear(); } catch (e) {} scannerRef.current = null; setCameraLoading(false); setIsCameraRunning(false); setScannedData(decoded); }, () => {}
                    ).then(() => { setCameraLoading(false); setIsCameraRunning(true); }).catch((err) => { console.error(err); setModal({ type: 'error', title: 'Camera Access', message: 'Permission denied.' }); setCameraLoading(false); setIsCameraRunning(false); });
                }, 200);
            };

            const handleManualEntry = () => {
                if (!manualInput.trim()) return;
                setScannedData(manualInput);
                setManualInput('');
                setManualMode(false);
                setStatus(processType === 'inward' ? 'Field Return' : 'Pass');
                setComment(''); setSelectedTags([]);
            };

            const handlePhoto = async (e) => {
                const file = e.target.files[0];
                if(file) {
                    setLoading(true);
                    try {
                        const data = await compressImage(file);
                        setPhotoData(data);
                        if (mode === 'advanced' && processType === 'outward') {
                            setIsAnalyzing(true); 
                            if (geminiKey) {
                                try {
                                    const aiResult = await callGeminiVision(geminiKey, data);
                                    setAiAnalysis({ verdict: aiResult.verdict || "Analyzed", confidence: aiResult.confidence || "N/A", suggestion: aiResult.suggestion || "Review Item" });
                                    if (aiResult.verdict && aiResult.verdict.toLowerCase().includes('defect')) { setStatus('Reject'); }
                                } catch (aiError) { setModal({ type: 'error', title: 'AI Failed', message: 'Check API Key.' }); }
                            } else {
                                setTimeout(() => { const isDefect = Math.random() > 0.7; setAiAnalysis({ verdict: isDefect ? 'Defect Detected' : 'Visual Pass', confidence: '95% (Sim)', suggestion: isDefect ? 'Reject' : 'Pass' }); if(isDefect) setStatus('Reject'); }, 1500);
                            }
                            setIsAnalyzing(false);
                        }
                    } catch(err) { setModal({ type: 'error', title: 'Image Error', message: 'Failed to process.' }); }
                    setLoading(false);
                }
            };

            const upload = async () => {
                if(!scriptUrl) return setModal({ type: 'error', title: 'Setup Required', message: 'Missing Google Script URL.' });
                if(loading || isAnalyzing) return;
                setLoading(true);
                const timestamp = new Date().toLocaleString();
                const finalAiTag = aiAnalysis ? aiAnalysis.verdict : (mode === 'advanced' ? 'Pending' : 'N/A');
                const combinedComment = [...selectedTags, comment].filter(Boolean).join(', ');
                const payloadCommon = { data: scannedData, batch: batchId, operator: operator, incharge: incharge, status: status, mode: mode, process_type: processType, ai_tags: finalAiTag, timestamp: timestamp, comment: combinedComment };
                const cloudPayload = { ...payloadCommon, image: photoData };
                const localPayload = { ...payloadCommon, image: null, has_photo: !!photoData };
                try {
                    await fetch(scriptUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(cloudPayload) });
                    const audio = new Audio('https://actions.google.com/sounds/v1/navigation/arrival_message_short.ogg');
                    audio.play().catch(e => console.log("Audio error", e));
                    setHistory(prev => [{...localPayload, id: Math.random().toString(36).substr(2, 9), sync: 'Done'}, ...prev]);
                    setScannedData(null); setPhotoData(null); setAiAnalysis(null); setComment(''); setSelectedTags([]);
                    setModal({ type: 'success', title: 'Uploaded', message: String(`${processType === 'outward' ? 'Outward' : 'Inward'} scan saved.`) });
                } catch (e) {
                    setHistory(prev => [{...localPayload, id: Math.random().toString(36).substr(2, 9), sync: 'Offline'}, ...prev]);
                    setModal({ type: 'error', title: 'Connection Failed', message: 'Saved to local history.' });
                } finally { setLoading(false); }
            };
            
            const activeNotes = status === 'Pass' ? NOTES_PASS : NOTES_REJECT;

            if (mode === 'select') {
                return (
                    <div className="h-full bg-gradient-to-br from-slate-900 to-slate-800 text-white p-6 flex flex-col justify-center overflow-y-auto">
                        <div className="text-center mb-10"><div className="mx-auto w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mb-4 shadow-lg shadow-blue-500/30"><Icons.Logo className="w-10 h-10 text-white" /></div><h1 className="text-3xl font-bold mb-2 tracking-tight">ProdSync</h1><p className="text-slate-400">Select Role Level</p></div>
                        <div className="space-y-4 max-w-md mx-auto w-full pb-10">
                            <div onClick={() => setMode('basic')} className="bg-white/5 p-4 rounded-xl flex items-center gap-4 cursor-pointer border hover:border-blue-500 border-transparent"><div className="p-3 bg-blue-500/20 rounded-lg text-blue-400"><Icons.Bolt /></div><div><h3 className="font-bold text-lg">Basic Tracker</h3><p className="text-xs text-slate-400">Scan & Log only.</p></div></div>
                            <div onClick={() => setMode('pro')} className="bg-white/5 p-4 rounded-xl flex items-center gap-4 cursor-pointer border hover:border-green-500 border-transparent"><div className="p-3 bg-green-500/20 rounded-lg text-green-400"><Icons.Shield /></div><div><h3 className="font-bold text-lg">Pro Inspector</h3><p className="text-xs text-slate-400">Photo + QC Status.</p></div></div>
                            <div onClick={() => setMode('advanced')} className="bg-white/5 p-4 rounded-xl flex items-center gap-4 cursor-pointer border hover:border-purple-500 border-transparent"><div className="p-3 bg-purple-500/20 rounded-lg text-purple-400"><Icons.Brain /></div><div><h3 className="font-bold text-lg">Intel Auditor</h3><p className="text-xs text-slate-400">AI + Auto-Route.</p></div></div>
                        </div>
                    </div>
                );
            }

            const themeColor = processType === 'outward' ? 'blue' : 'orange';
            const themeBg = processType === 'outward' ? 'bg-blue-600' : 'bg-orange-600';
            const themeBorder = processType === 'outward' ? 'border-blue-500' : 'border-orange-500';

            return (
                <div className="flex flex-col h-full max-w-md mx-auto bg-slate-50 shadow-2xl md:border md:rounded-xl md:my-4 md:h-[95vh]">
                    <Modal isOpen={!!modal} type={modal?.type} title={modal?.title} message={modal?.message} onClose={() => setModal(null)} />
                    {loading && (<div className="fixed inset-0 z-[300] flex flex-col items-center justify-center bg-black/80 backdrop-blur-sm animate-fade-in"><div className="relative mb-4"><div className="w-16 h-16 border-4 border-slate-600 rounded-full"></div><div className="absolute top-0 left-0 w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div></div><h3 className="text-white font-bold text-lg tracking-wide flex items-center gap-2"><Icons.CloudUpload className="w-5 h-5" /> Syncing...</h3></div>)}
                    <AdminGate isOpen={showAdmin} onClose={() => setShowAdmin(false)} onSuccess={onAdminSuccess} />
                    <div className={`p-4 text-white shadow-lg shrink-0 ${themeBg} transition-colors duration-300`}>
                        <div className="flex justify-between items-center mb-3"><div className="font-bold flex items-center gap-2"><div className="bg-white/20 p-1 rounded"><Icons.Logo className="w-4 h-4" /></div><span className="tracking-wider text-sm">ProdSync</span></div><button onClick={() => requestAdmin('SWITCH_MODE')} className="text-[10px] bg-black/20 hover:bg-black/30 px-2 py-1 rounded flex items-center gap-1"><Icons.Lock className="w-3 h-3" /> ROLE</button></div>
                        <div className="flex bg-black/20 p-1 rounded-lg"><button onClick={() => setProcessType('outward')} className={`flex-1 py-1.5 text-xs font-bold rounded-md flex items-center justify-center gap-1 transition-all ${processType === 'outward' ? 'bg-white text-blue-600 shadow-sm' : 'text-white/70 hover:text-white'}`}><Icons.Bolt className="w-3 h-3" /> OUTWARD</button><button onClick={() => setProcessType('inward')} className={`flex-1 py-1.5 text-xs font-bold rounded-md flex items-center justify-center gap-1 transition-all ${processType === 'inward' ? 'bg-white text-orange-600 shadow-sm' : 'text-white/70 hover:text-white'}`}><Icons.Repeat className="w-3 h-3" /> INWARD</button></div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {view === 'scan' && (
                            <div className="animate-fade-in space-y-4 pb-20">
                                <div className="bg-white p-3 rounded-xl shadow-sm border border-slate-200 space-y-3">
                                    {processType === 'outward' ? (<React.Fragment><div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-1">Batch ID</label><input type="text" value={batchId} onChange={e => setBatchId(e.target.value)} className={`w-full p-2 bg-slate-50 border border-slate-200 rounded-lg font-mono text-sm outline-none focus:${themeBorder} focus:ring-1 focus:ring-${themeColor}-500 transition-all`} placeholder="ENTER-BATCH-ID" /></div><div className="grid grid-cols-2 gap-3"><div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-1">Operator</label><input type="text" value={operator} onChange={e => setOperator(e.target.value)} className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:border-blue-500 transition-all" placeholder="Name" /></div><div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-1">Incharge</label><input type="text" value={incharge} onChange={e => setIncharge(e.target.value)} className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:border-blue-500 transition-all" placeholder="Name" /></div></div></React.Fragment>) : (<div className="text-center py-2"><div className="text-orange-500 font-bold text-sm mb-1">INWARD RETURN MODE</div><div className="text-xs text-slate-400">Scanning items returned from field for repair.</div></div>)}
                                </div>
                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden min-h-[320px] relative flex flex-col">
                                    {manualMode ? (
                                        <div className="flex-1 flex flex-col p-6 items-center justify-center"><h3 className="font-bold text-lg text-slate-700 mb-4">Manual Entry</h3><input type="text" value={manualInput} onChange={e => setManualInput(e.target.value)} className="w-full p-4 border-2 border-slate-300 rounded-xl text-lg font-mono text-center mb-4 focus:border-blue-500 outline-none" placeholder="TYPE CODE HERE" autoFocus /><div className="flex gap-3 w-full"><button onClick={() => setManualMode(false)} className="flex-1 py-3 font-bold text-slate-500 bg-slate-100 rounded-xl">Cancel</button><button onClick={handleManualEntry} className={`flex-1 py-3 font-bold text-white rounded-xl ${themeBg}`}>Confirm</button></div></div>
                                    ) : !scannedData ? (
                                        <div className="flex-1 flex flex-col bg-slate-900 relative"><div id="reader" className="flex-1 w-full h-full"></div>{!cameraLoading && !isCameraRunning && (<div className="absolute inset-0 flex flex-col items-center justify-center text-slate-500 pointer-events-none"><Icons.Camera className="w-12 h-12 mb-2 opacity-50"/><p>Camera Ready</p></div>)}<div className="flex relative z-10"><button onClick={startScan} disabled={cameraLoading} className={`flex-[2] py-5 font-bold text-white tracking-wide transition-colors ${themeBg} brightness-110 hover:brightness-125 disabled:opacity-90 disabled:cursor-not-allowed flex items-center justify-center gap-2`}>{cameraLoading ? (<React.Fragment><span>STARTING...</span><span onClick={(e) => { e.stopPropagation(); stopCamera(); }} className="bg-white/20 p-1 rounded-full hover:bg-white/40"><Icons.X className="w-4 h-4"/></span></React.Fragment>) : isCameraRunning ? (<React.Fragment><span>STOP CAMERA</span><Icons.StopCircle className="w-5 h-5"/></React.Fragment>) : 'TAP TO SCAN'}</button><button onClick={() => setManualMode(true)} disabled={cameraLoading || isCameraRunning} className="flex-1 bg-slate-800 text-white border-l border-slate-700 flex items-center justify-center hover:bg-slate-700 disabled:opacity-50"><Icons.Keyboard className="w-6 h-6" /></button></div></div>
                                    ) : (
                                        <div className="flex-1 flex flex-col p-4 space-y-4 bg-white">
                                            <div className="bg-slate-50 border border-slate-200 p-4 rounded-xl flex items-start gap-3"><div className={`p-2 rounded-full text-white ${themeBg}`}><Icons.Check className="w-5 h-5"/></div><div className="overflow-hidden"><div className="text-xs font-bold text-slate-500 uppercase">Decoded Data</div><div className="font-mono font-bold text-slate-800 break-all">{String(scannedData)}</div></div></div>
                                            {mode === 'advanced' && processType === 'outward' && (isAnalyzing ? (<div className="bg-purple-50 text-purple-600 p-4 rounded-xl text-center border border-purple-100 flex flex-col items-center justify-center h-20"><Icons.Brain className="w-5 h-5 animate-bounce mb-1"/><span className="font-bold text-xs">AI Analyzing...</span></div>) : aiAnalysis && (<div className="bg-purple-50 text-purple-800 p-3 rounded-xl text-sm border border-purple-100 animate-fade-in"><div className="flex justify-between items-center mb-1"><span className="flex items-center gap-2 font-bold"><Icons.Brain className="w-4 h-4"/> AI Verdict</span><span className="text-xs bg-white text-purple-600 px-1.5 rounded border border-purple-100">{aiAnalysis.confidence}</span></div><div className="font-medium">{aiAnalysis.verdict}</div></div>))}
                                            {/* FIXED: Pass/Reject buttons now visible for ALL modes when type is outward */}
                                            <div>
                                                <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Action Status</label>
                                                {processType === 'outward' ? (
                                                    <div className="grid grid-cols-2 gap-3">
                                                        <button onClick={() => setStatus('Pass')} className={`py-3 text-sm rounded-lg font-bold border transition-colors ${status === 'Pass' ? 'bg-emerald-100 border-emerald-500 text-emerald-700' : 'bg-slate-50 border-slate-200 text-slate-500'}`}>PASS</button>
                                                        <button onClick={() => setStatus('Reject')} className={`py-3 text-sm rounded-lg font-bold border transition-colors ${status === 'Reject' ? 'bg-rose-100 border-rose-500 text-rose-700' : 'bg-slate-50 border-slate-200 text-slate-500'}`}>REJECT</button>
                                                    </div>
                                                ) : (
                                                    <div className="w-full"><button disabled className="w-full py-3 text-sm rounded-lg font-bold border bg-orange-100 border-orange-500 text-orange-700">FIELD RETURN</button></div>
                                                )}
                                            </div>
                                            {mode !== 'basic' && (<div className="flex-1 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50 relative group overflow-hidden min-h-[120px] flex flex-col items-center justify-center hover:bg-slate-100 transition-colors">{!photoData ? <div onClick={() => fileRef.current?.click()} className="text-center cursor-pointer p-4 w-full h-full flex flex-col justify-center items-center"><Icons.Camera className="w-6 h-6 text-slate-400 mb-1 mx-auto"/><span className="text-xs font-bold text-slate-500">Add Photo</span><input type="file" ref={fileRef} className="hidden" accept="image/*" capture="environment" onChange={handlePhoto}/></div> : <React.Fragment><img src={photoData} className="absolute inset-0 w-full h-full object-cover"/><button onClick={() => setPhotoData(null)} className="absolute bottom-2 right-2 bg-white text-rose-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-lg border border-rose-100 flex items-center gap-1"><Icons.Trash className="w-3 h-3"/> Retake</button></React.Fragment>}</div>)}
                                            <div className="mb-1 animate-fade-in"><label className="text-xs font-bold text-slate-400 uppercase mb-2 block">{status} Checklist</label><div className="flex flex-wrap gap-2">{activeNotes.map(tag => (<button key={tag} onClick={() => toggleTag(tag)} className={`px-3 py-1.5 text-[10px] font-bold rounded-full border transition-all ${selectedTags.includes(tag) ? 'bg-slate-700 text-white border-slate-700' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}>{tag}</button>))}</div></div>
                                            <div><textarea value={comment} onChange={e => setComment(e.target.value)} placeholder="Additional comments..." className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none resize-none" rows="2"></textarea></div>
                                            <div className="grid grid-cols-2 gap-3 mt-auto pt-2"><button onClick={() => setScannedData(null)} className="py-3.5 rounded-xl font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 transition-colors">Cancel</button><button onClick={upload} disabled={loading || isAnalyzing} className={`py-3.5 rounded-xl font-bold text-white ${themeBg} brightness-110 hover:brightness-125 disabled:bg-slate-300 shadow-lg transition-colors`}>{loading ? 'Saving...' : 'Upload'}</button></div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        {view === 'history' && (
                            <div className="animate-fade-in space-y-4 pb-20">
                                <div className="flex justify-between items-center"><h2 className="font-bold text-slate-700">Session Log</h2><div className="flex gap-2"><button onClick={generateAiSummary} className="text-purple-600 bg-purple-50 px-3 py-1.5 rounded-lg text-xs font-bold border border-purple-100 flex items-center gap-1 hover:bg-purple-100"><Icons.Brain className="w-3 h-3"/> AI Summary</button>{mode === 'advanced' && history.length > 0 && <button onClick={() => generatePDF(history, batchId)} className="text-purple-600 bg-purple-50 px-3 py-1.5 rounded-lg text-xs font-bold border border-purple-100 flex items-center gap-1 hover:bg-purple-50"><Icons.FileText className="w-3 h-3"/> PDF</button>}<button onClick={() => requestAdmin('CLEAR_HISTORY')} className="text-rose-500 bg-rose-50 px-3 py-1.5 rounded-lg text-xs font-bold border border-rose-100 flex items-center gap-1 hover:bg-rose-100"><Icons.Trash className="w-3 h-3"/> Clear</button></div></div>
                                {history.map((item, i) => (<div key={i} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col gap-2"><div className="flex justify-between items-start"><div><div className="font-bold text-sm text-slate-800">{item.data}</div><div className="text-xs text-slate-500 mt-0.5 flex items-center gap-2"><span>{item.timestamp ? item.timestamp.split(',')[1] : ''}</span><span className={`px-1.5 rounded text-[10px] uppercase font-bold ${item.process_type === 'inward' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`}>{item.process_type === 'inward' ? 'IN' : 'OUT'}</span></div></div><div className={`text-[10px] px-2 py-0.5 rounded-full font-bold border ${item.status === 'Pass' ? 'bg-emerald-50 text-emerald-600 border-emerald-200' : item.status === 'Reject' ? 'bg-rose-50 text-rose-600 border-rose-200' : 'bg-orange-50 text-orange-600 border-orange-200'}`}>{item.status}</div></div>{item.comment && <div className="text-xs text-slate-600 bg-slate-50 p-2 rounded border border-slate-100 italic">"{String(item.comment)}"</div>}</div>))}
                            </div>
                        )}
                        
                        {/* HELPER VIEW REPLACES SETTINGS */}
                        {view === 'settings' && (<div className="animate-fade-in space-y-4 pb-20">
                             <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100"><label className="text-xs font-bold text-slate-400 uppercase block mb-2">Google Script URL</label><textarea value={scriptUrl} onChange={e => setScriptUrl(e.target.value)} className="w-full p-3 bg-slate-50 border rounded-lg text-xs font-mono focus:ring-2 focus:ring-blue-500 outline-none text-slate-600" rows="4" placeholder="https://script.google.com/..."></textarea></div>
                             <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100"><label className="text-xs font-bold text-slate-400 uppercase block mb-2">Gemini API Key (Optional)</label><input type="password" value={geminiKey} onChange={e => setGeminiKey(e.target.value)} className="w-full p-3 bg-slate-50 border rounded-lg text-xs font-mono focus:ring-2 focus:ring-blue-500 outline-none text-slate-600" placeholder="AI Studio Key..." /><p className="text-[10px] text-slate-400 mt-1">Required for AI Visual Inspection & Summaries.</p></div>
                             
                             {/* Dedicated Help Section */}
                             <div className="mt-6 space-y-3">
                                 <HelpItem title="How to Use">
                                     <ul className="list-disc pl-4 space-y-1">
                                         <li><strong>Scan:</strong> Tap 'Tap to Scan' to read QR.</li>
                                         <li><strong>Status:</strong> Select PASS or REJECT.</li>
                                         <li><strong>Evidence:</strong> Take photo in Pro mode.</li>
                                         <li><strong>Upload:</strong> Syncs to Google Sheet immediately.</li>
                                     </ul>
                                 </HelpItem>
                                 <HelpItem title="Modes Explained">
                                     <ul className="list-disc pl-4 space-y-1">
                                         <li><strong>Basic:</strong> Quick scan & log. No photos.</li>
                                         <li><strong>Pro:</strong> Adds Photo proof & QC status.</li>
                                         <li><strong>Advanced:</strong> AI-assisted defect detection.</li>
                                     </ul>
                                 </HelpItem>
                                 <HelpItem title="Troubleshooting">
                                     <p>If camera freezes: Refresh page or tap Stop Camera. Ensure browser permissions are allowed.</p>
                                 </HelpItem>
                             </div>
                             
                             <div className="text-center text-xs text-slate-400 mt-8 mb-8">ProdSync {APP_VERSION} â€¢ Industrial Operations</div>
                        </div>)}
                        {/* HELP VIEW (New Separate Tab) */}
                        {view === 'help' && (<div className="animate-fade-in space-y-4 pb-20">
                            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                                <h2 className="font-bold text-lg text-slate-800 mb-4">User Guide</h2>
                                <div className="space-y-3">
                                     <HelpItem title="How to Use">
                                         <ul className="list-disc pl-4 space-y-1">
                                             <li><strong>Scan:</strong> Tap 'Tap to Scan' to read QR.</li>
                                             <li><strong>Status:</strong> Select PASS or REJECT.</li>
                                             <li><strong>Evidence:</strong> Take photo in Pro mode.</li>
                                             <li><strong>Upload:</strong> Syncs to Google Sheet immediately.</li>
                                         </ul>
                                     </HelpItem>
                                     <HelpItem title="Modes Explained">
                                         <ul className="list-disc pl-4 space-y-1">
                                             <li><strong>Basic:</strong> Quick scan & log. No photos.</li>
                                             <li><strong>Pro:</strong> Adds Photo proof & QC status.</li>
                                             <li><strong>Advanced:</strong> AI-assisted defect detection.</li>
                                         </ul>
                                     </HelpItem>
                                     <HelpItem title="Troubleshooting">
                                         <p>If camera freezes: Refresh page or tap Stop Camera. Ensure browser permissions are allowed.</p>
                                     </HelpItem>
                                     <HelpItem title="Add to Home Screen">
                                        <ul className="list-disc pl-4 space-y-1">
                                            <li><strong>Android (Chrome):</strong> Tap the 3-dot menu âž” "Add to Home screen".</li>
                                            <li><strong>iOS (Safari):</strong> Tap Share button âž” "Add to Home Screen".</li>
                                        </ul>
                                     </HelpItem>
                                </div>
                            </div>
                        </div>)}
                    </div>

                    <div className="bg-white border-t border-slate-200 flex justify-around py-3 text-[10px] font-bold text-slate-400 uppercase tracking-wide shrink-0 pb-safe w-full fixed bottom-0 max-w-md md:absolute shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                        <button onClick={() => setView('scan')} className={`flex flex-col items-center gap-1 transition-colors ${view === 'scan' ? `text-${themeColor}-600` : 'hover:text-slate-600'}`}><Icons.Camera className="w-6 h-6"/> Scan</button>
                        <button onClick={() => setView('history')} className={`flex flex-col items-center gap-1 transition-colors ${view === 'history' ? `text-${themeColor}-600` : 'hover:text-slate-600'}`}><Icons.FileText className="w-6 h-6"/> Log</button>
                        <button onClick={() => setView('help')} className={`flex flex-col items-center gap-1 transition-colors ${view === 'help' ? `text-${themeColor}-600` : 'hover:text-slate-600'}`}><Icons.Help className="w-6 h-6"/> Help</button>
                        <button onClick={() => requestAdmin('SETUP')} className={`flex flex-col items-center gap-1 transition-colors ${view === 'settings' ? `text-${themeColor}-600` : 'hover:text-slate-600'} relative`}><Icons.Settings className="w-6 h-6"/> Setup <div className="absolute -top-1 -right-1 bg-slate-100 rounded-full p-0.5 border border-slate-200"><Icons.Lock className="w-2 h-2 text-slate-400"/></div></button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>